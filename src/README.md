# src 


## 各个模块说明

``` ASCII
src/
├── lib/
│   ├── combinators/     # 组合子模块，提供了基础的组合子函数。
│   ├── constants/       # 一些全局共享的常量模块，包括环境变量，统一通过该模块进行管理
│   ├── types/          # 通用类型定义模块，一些局部类型定义会写在对应的子模块下。
│   ├── utils/          # 通用工具函数
│   └── index.ts        # 项目入口文件
├── database/
│   ├── entity/         # 数据库实体定义
│   └── datasource.ts   # 数据库连接配置
└── index.ts        # 项目入口文件
```

## 主要使用的接口列表

1. `/group/${groupId}/topics` 获取小组帖子列表
2. `/group/topic/${topicId}` 获取小组帖子详情
3. `/group/topic/${topicId}/comments` 获取小组帖子回复列表

## 快照周期说明

快照分为以下几种：
1. 对于用户信息的快照。这一部分快照主要收集用户的 ip 地址、性别、姓名、uid、头像变化
2. 对于帖子统计数据的快照。这一部分快照主要收集帖子的回复数、收藏数等变化。主要是统计数据。请注意，这不是帖子内容的快照。
3. 对于帖子内容的快照。这一部分快照主要收集帖子的主楼内容的变化。

存储的数据分为以下几种：
1. 快照信息。快照信息是一种时序数据。存在 用户信息 快照、帖子统计数据快照、帖子内容快照 三种。
2. 回复数据。存储的内容数据大头。

思路上，是根据接口数据，提取出我们关注的特征数据，然后通过与数据库的交互层交互，根据特征判断是否有新的快照记录需要生成/是否需要插入新的回复数据，而后根据需求转化为相应的存储数据进行存储。

即：**接口数据** -> **特征数据** -> **存储数据** / **存储的快照数据**

存在以下特征数据：
1. 用户快照特征。
2. 帖子统计快照特征。
3. 帖子内容快照特征。
4. 回复获取特征。该特征指的是要获取哪一范围内的数据。

因此，存在以下周期以及对应的操作：

### 1. 基本元数据获取周期

我们认为帖子数据是基本元数据，因为只有获得了帖子数据，我们才能去构建、收集回复数据、用户信息等其他数据。

因而存在以下操作：

1. 通过 `/group/${groupId}/topics` 接口获取小组当前状态下的信息。而后会尝试提取出 用户快照特征 以及相应的 帖子id 列表。
2. 根据特征,首先进行快照上的存储解析：
- 对于用户快照特征，会在数据库中进行比对。假如用户快照特征发生变化，那么新建对应的快照记录。如果用户数据不存在，同样会先创建相应的索引记录。
3. 首先根据帖子列表id，通过 `/group/topic/${topicId}` 接口，获取 帖子统计快照特征,帖子内容快照特征 
- 对于帖子统计快照特征，会在数据库中进行比对，假如发生变化，则基于帖子统计快照特征数据新建对应的统计快照记录。如果帖子数据不存在，同样会先创建相应的索引记录。
- 对于帖子内容快照特征，会在数据库中进行比对，假如发生变化，则基于帖子内容快照特征数据新建对应的帖子内容快照记录。如果帖子数据不存在，同样会先创建相应的索引记录。

4. 而后是尝试构建回复数据同步队列。数据同步队列是去拉取某个帖子的回复数据用的。这一个比较复杂。

> 先考虑我们得到的 帖子统计信息快照 ，它存在的信息有：快照创建时间，回复数量
> 再考虑我们的 帖子内容快照 信息，它有：帖子最后被回复时间
> 帖子的回复数据变化是这两种情况：1. 新增回复 2. 回复被删除，回复数减少 3.回复删除了，然后又有新增回复，总数量不变 4. 以前的回复被删除了
> 而无论是新增回复还是回复被删除，帖子最后被回复时间都会更替。帖子最后被回复时间永远是最后一条回复的发布时间。
> 这一点比较头疼。因此我们决定每次获取帖子都获取相应的全部回复数据去更新。

故而步骤有：

1. 根据帖子 id 去数据库内获取对应帖子存储的当前回复数量，如果数量是 0 ，那么显然要构建对应的回复数据,加入到同步队列中。
2. 根据 帖子统计快照特征 的帖子最后被回复时间， 去对比数据库存储的 topic 索引记录的 last_reply_at ，如果它们之间不相等，那么显然要构建对应的回复数据,加入到同步队列中。

元数据获取周期是单独的周期。每隔一分钟执行一次。

### 2. 数据同步周期

数据同步周期里，会尝试通过回复数据同步队列获取回复数据，并再一次基于回复数据去尝试做用户快照。

数据同步队列的单个对象包括以下结构信息：
1. 帖子 id
2. 当前数据库内存储的回复的数量
3. 由帖子统计快照特征得到的，当前帖子的回复数量

在尝试获取回复时，还会进行路径的判断：
1. 如果当前数据库内存储的回复数量小于 帖子统计快照特征得到的回复数量，那么显然要获取新增的回复数据。此时是增量数据获取。
2. 否则都是全量数据获取。

数据同步周期每 2 分钟执行一次。对于执行失败的单个任务，会将失败的任务重新放回队列中。

由于是并发环境，因此我们不考虑对队列加锁。队列被读取后，相应任务会被移除。

总地来说，该周期步骤为：
1. 根据同步队列中的任务，尝试获取回复数据
2. 根据回复数据，构建每个回复数据的 用户快照特征 以及 回复数据特征
3. 先保存 用户快照 特征，再保存 回复数据特征 。由于存在短路，不用担心 对应用户 不存在的问题

### 3. TODO 缓存构建周期

该部分内容是 TODO 项。期望是可以构筑例如回复链的缓存数据，方便快速获取信息。