# src 


## 各个模块说明

``` ASCII
src/
├── lib/
│   ├── combinators/     # 组合子模块，提供了基础的组合子函数。
│   ├── constants/       # 一些全局共享的常量模块，包括环境变量，统一通过该模块进行管理
│   ├── types/          # 通用类型定义模块，一些局部类型定义会写在对应的子模块下。
│   ├── utils/          # 通用工具函数
│   └── index.ts        # 项目入口文件
├── database/
│   ├── entity/         # 数据库实体定义
│   └── datasource.ts   # 数据库连接配置
└── index.ts        # 项目入口文件
```

## 主要使用的接口列表

1. `/group/${groupId}/topics` 获取小组帖子列表
2. `/group/topic/${topicId}` 获取小组帖子详情
3. `/group/topic/${topicId}/comments` 获取小组帖子回复列表

## 快照周期说明

快照分为以下几种：
1. 对于用户信息的快照。这一部分快照主要收集用户的 ip 地址、性别、姓名、uid、头像变化
2. 对于帖子统计数据的快照。这一部分快照主要收集帖子的回复数、收藏数等变化。主要是统计数据。请注意，这不是帖子内容的快照。
3. 对于帖子内容的快照。这一部分快照主要收集帖子的主楼内容的变化。

存储的数据分为以下几种：
1. 快照信息。快照信息是一种时序数据。存在 用户信息 快照、帖子统计数据快照、帖子内容快照 三种。
2. 回复数据。存储的内容数据大头。

思路上，是根据接口数据，提取出我们关注的特征数据，然后通过与数据库的交互层交互，根据特征判断是否有新的快照记录需要生成/是否需要插入新的回复数据，而后根据需求转化为相应的存储数据进行存储。

即：**接口数据** -> **特征数据** -> **存储数据** / **存储的快照数据**

存在以下特征数据：
1. 用户快照特征。
2. 帖子统计快照特征。
3. 帖子内容快照特征。
4. 回复获取特征。该特征指的是要获取哪一范围内的数据。

因此，存在以下周期以及对应的操作：

### 1. 小组监控周期

1. 小组监控周期。通过 `/group/${groupId}/topics` 接口获取小组当前状态下的信息。而后会尝试提取出 用户快照特征
2. 根据特征,首先进行快照上的存储解析：
- 对于用户快照特征，会在数据库中进行比对。假如用户快照特征发生变化，那么新建对应的快照记录。如果用户数据不存在，同样会先创建相应的索引记录。
3. 在小组监控周期结束后，根据特征，进行数据同步周期。

### 2. 数据同步周期
1. 在小组周期提取的特征里，会首先根据帖子列表id，通过 `/group/topic/${topicId}` 接口，获取 帖子统计快照特征,帖子内容快照特征 
- 对于帖子统计快照特征，会在数据库中进行比对，假如发生变化，则基于帖子统计快照特征数据新建对应的统计快照记录。如果帖子数据不存在，同样会先创建相应的索引记录。
- 对于帖子内容快照特征，会在数据库中进行比对，假如发生变化，则基于帖子内容快照特征数据新建对应的帖子内容快照记录。如果帖子数据不存在，同样会先创建相应的索引记录。

2. 而后，会根据 帖子统计快照特征 与数据库内对应的记录进行比对，提取出相应的 回复获取特征 ，而后根据回复获取特征去获取回复数据。

3. 在获取回复数据时，同时会尝试构建用户快照特征，判断是否需要更新快照

### 3. TODO 缓存构建周期

该部分内容是 TODO 项。期望是可以构筑例如回复链的缓存数据，方便快速获取信息。